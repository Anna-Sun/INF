#!/bin/bash

export job=$1
export list=${INF}/work/INF1.merge-rsid
export p=$(awk -v job=${job} 'NR==job+1{print $5}' ${list})
export r=$(sed '1d' ${list} | awk -v job=${job} 'NR==job{print $6}')
export pr=${p}-${r}
export chr=$(sed '1d' ${list} | awk -v job=${job} 'NR==job{print $8}')
export pos=$(sed '1d' ${list} | awk -v job=${job} 'NR==job{print $9}')
export flanking=1e6
export start=$(sed '1d' ${list} | awk -v job=${job} -v d=${flanking} 'NR==job{start=$2-d;if(start<0) start=0; print start}')
export end=$(sed '1d' ${list} | awk -v job=${job} -v d=${flanking} 'NR==job{print $3+d}')
export sumstats=$SCALLOP/jp549/olink-merged-output/$(ls $SCALLOP/jp549/olink-merged-output | grep ${p}___)
export N=4994
export TMPDIR=/tmp
export dir=${INF}/sentinels

if [ "${study}" == "" ] || [ "${data_type}" == "" ] || [ "${sample}" == "" ]; then
   echo study and sample are not set ... exit
   exit 1
fi

function prune()
{
  module load plink/2.00-alpha
  plink2 --bfile ${INF}/INTERVAL/per_chr/interval.imputed.olink.chr_${chr} \
         --chr ${chr} --from-bp ${start} --to-bp ${end} \
         --geno 0.1 --mind 0.1 --maf 0.01 --indep-pairwise 1000kb 1 0.8 --out ${pr}-jam
  if [ $(grep -w ${r} ${pr}-jam.prune.in | wc -l) -eq 0 ]; then
     export i=$(grep -w -f ${pr}-jam.prune.in ${INF}/INTERVAL/per_chr/interval.imputed.olink.chr_${chr}.bim | \
     awk -vpos=${pos} 'function abs(x) {if (x<0) return -x; else return x;}
         {d=$4-pos;print $1, $2, $4, d}' | sort -r -k4,4n | awk 'NR==1 {print $2}')
     sed -i 's/'"$i"'/'"$r"'/g' ${pr}-jam.prune.in
  fi
  if [ ${chr} -eq 19 ]; then
     sort ${pr}-jam.prune.in | join -v1 - NLRP2 > ${pr}-jam.prune
  else
     sort ${pr}-jam.prune.in > ${pr}-jam.prune
  fi
  rm ${pr}-jam.log ${pr}-jam.prune.in ${pr}-jam.prune.out
}

function jam()
{
  awk 'NR > 1{print $1}' ${pr}.z | sort | join - ${pr}-jam.prune > ${pr}-jam.incl
# bgen
  qctool -g ${INF}/INTERVAL/per_chr/interval.imputed.olink.chr_${chr}.bgen -og ${pr}-jam.bgen -ofiletype bgen -incl-rsids ${pr}-jam.incl
# bgi
  bgenix -g ${pr}-jam.bgen -index -clobber
  ln -sf ${pr}-jam.bgen.bgi ${pr}-jam.bgi
  if [ ${data_type} != "bgen" ]; then
     qctool -g ${pr}-jam.bgen -filetype bgen -s ${sample} -ofiletype binary_ped -og ${pr}-jam;
  fi
  R -q --no-save < ${INF}/rsid/jam.R > /dev/null
}

prune
jam
rm ${pr}-jam.incl ${pr}-jam.prune
rm ${pr}-jam.bgen ${pr}-jam.bgen.bgi ${pr}-jam.bgi
if [ ${data_type} != "bgen" ]; then rm ${pr}-jam.bed ${pr}-jam.bim ${pr}-jam.fam; fi
