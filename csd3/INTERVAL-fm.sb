#!/bin/bash

#SBATCH --account=PETERS-SL3-CPU
#SBATCH --ntasks=1
#SBATCH --job-name=_fm_INTERVAL
#SBATCH --time=12:00:00
#SBATCH --partition=skylake
#SBATCH --array=1-110%15
#SBATCH --mem=128800
#SBATCH --output=/rds/user/jhz22/hpc-work/work/_fm_%A_%a.out
#SBATCH --error=/rds/user/jhz22/hpc-work/work/_fm_%A_%a.err
#SBATCH --export ALL

export INF=/rds/project/jmmh2/rds-jmmh2-projects/olink_proteomics/scallop/INF
export TMPDIR=/rds/user/jhz22/hpc-work/work
export job=${SLURM_ARRAY_TASK_ID}
export bindir=/rds-d4/user/jhz22/hpc-work/bin
export dir=${INF}/INTERVAL
export list=${dir}/INTERVAL_nold.sentinels
export p=$(awk -v job=${job} 'NR==job+1{print $1}' ${list})
export chr=$(awk -v job=${job} 'NR==job+1{print $2}' ${list})
export pos=$(awk -v job=${job} 'NR==job+1{print $3}' ${list})
export r=$(awk -v job=${job} 'NR==job+1{print $4}' ${list})
export pr=${p}-${r}
export sumstats=${INF}/sumstats/INTERVAL/INTERVAL.${p}.gz
export flanking=1e6
export start=$(awk -vpos=${pos} -vflanking=${flanking} 'BEGIN{start=pos-flanking;if(start<0) start=0;print start}')
export end=$(awk -vpos=${pos} -vflanking=${flanking} 'BEGIN{print pos+flanking}')
export bfile=${INF}/INTERVAL/INTERVAL
export sample=o5000-inf1-outlier_in-r2.sample
export snpid_rsid=${INF}/work/INTERVAL.rsid
export study=INTERVAL
export N=4994

function init()
{
  plink-1.9 --bfile ${bfile} \
            --snp ${r} \
            --window 1000 \
            --maf 0.01 \
            --indep-pairwise 1000kb 1 0.8 \
            --out ${dir}/${pr}
  if [ $(grep ${r} ${dir}/${pr}.prune.in | wc -l) -eq 0 ]; then
     (
       echo ${r}
       cat ${dir}/${pr}.prune.in
     ) > $TMPDIR/${pr}
     plink-1.9 --bfile ${bfile} \
               --extract $TMPDIR/${pr} \
               --r2 square \
               --out $TMPDIR/${pr}
     export i=$(paste $TMPDIR/${pr} $TMPDIR/${pr}.ld | cut -f1,2 | sort -r -k2,2g | awk 'NR==1 {print $1}')
     sed -i 's/'"$i"'/'"$r"'/g' ${dir}/${pr}.prune.in
  fi
  sort -k1,1 ${dir}/${pr}.prune.in > $TMPDIR/${pr}.prune.in
  awk 'NR > 1' ${dir}/${p}.ma | \
  sort -k1,1 | \
  join -j1 - $TMPDIR/${pr}.prune.in | \
  awk '{print $1}' > ${dir}/${pr}
  sort -k1,1 ${snpid_rsid} | join -a2 - ${pr} > ${pr}.rsid
  R --no-save -q <<\ \ END
      f <- Sys.getenv("pr")
      snpid_rsid <- read.table(paste0(f,".rsid"), as.is=TRUE, col.names=c("rsid","name"), fill=TRUE)
      nmiss <- with(snpid_rsid,name=="")
      snpid_rsid <- within(snpid_rsid, {name[nmiss] <- make.names(rsid[nmiss])})
      save(snpid_rsid, file=paste0(f,".rda"))
  END
# z0
  (
    zcat ${sumstats} | \
    awk 'NR > 1' | \
    sort -k1,1 | \
    awk -vchr=${chr} -vstart=${start} -vend=${end} '
    {
      if ($2==chr && $3 >= start && $3 < end) {
      if ($8 < 0.5) maf = $8; else maf = 1-$8
      if (maf > 0 && maf <= 0.5 && $9 != "NA" && $10 != "NA") print $1, $2, $3, $7, $6, maf, $9, $10
    }
    } ' | \
    join ${dir}/${pr} -
  ) > ${pr}.z0
  awk '{print $1} ' ${pr}.z0 > ${pr}.incl
# bgen
  qctool -g ${bfile}.bed -filetype binary_ped -og ${pr}.bgen -ofiletype bgen -incl-rsids ${pr}.incl
# bgi
  bgenix -g ${pr}.bgen -index -clobber
  ln -sf ${pr}.bgen.bgi ${pr}.bgi
  qctool -g ${pr}.bgen -snp-stats -osnp - > ${pr}.snp-stats
  (
    join <(cut -d' ' -f1,4,5 ${pr}.z0 | sort -k1,1) <(awk '!/\#/' ${pr}.snp-stats | cut -f1,5,6 | awk 'NR>1' | sort -k1,1) | \
    awk '{print $1, ($2!=$4)}'
  ) > ${pr}.flip
  (
    awk 'BEGIN {print "rsid", "chromosome", "position", "allele1", "allele2", "maf", "beta", "se", "flip"}'
    join ${pr}.z0 ${pr}.flip | awk '{if($9==1) {t=$4;$4=$5;$5=t};$7=-$7; print}'
  ) > ${pr}.z
}

function finemap()
{
# master
  (
    echo "z;bgen;bgi;dose;snp;config;cred;log;n_samples"
    echo "${pr}.z;${pr}.bgen;${pr}.bgi;${pr}.dose;${pr}.snp;${pr}.config;${pr}.cred;${pr}.log;$N"
  ) > ${pr}.master
# finemap
  rm -rf ${pr}.cred ${pr}.dose ${pr}.snp ${pr}.config
  ${bindir}/finemap --sss --in-files ${pr}.master
  R -q --no-save <<\ \ END
    options(digits=3, scipen=20, width=500)
    pr <- Sys.getenv("pr")
    cat(pr, "\n")
    snp <- read.table(paste0(pr, ".snp"), as.is=TRUE, header=TRUE)
    config <- read.table(paste0(pr,".config"),as.is=TRUE,header=TRUE)
    cred <- read.table(paste0(pr,".cred"),as.is=TRUE,header=TRUE)
    load(paste0(pr,".rda"))
    library(openxlsx)
    xlsx <- paste0(pr, "-finemap.xlsx")
    unlink(xlsx, recursive = FALSE, force = TRUE)
    wb <- createWorkbook(xlsx)
    f <- make.names(pr)
    addWorksheet(wb, "snpid_rsid")
    writeDataTable(wb, "snpid_rsid", snpid_rsid)
    addWorksheet(wb, paste0(f, ".snp"))
    writeDataTable(wb, paste0(f, ".snp"), snp)
    addWorksheet(wb, paste0(f, ".cfg"))
    writeDataTable(wb, paste0(f, ".cfg"), config)
    addWorksheet(wb, paste0(f, ".cs"))
    writeDataTable(wb, paste0(f, ".cs"), cred)
    saveWorkbook(wb, file=xlsx, overwrite=TRUE)
  END
}

function gcta()
{
  if [ -f ${dir}/${pr}.jma.cojo ]; then rm ${dir}/${pr}.jma.cojo ${dir}/${pr}.ldr.cojo; fi
  gcta-1.9 --bfile ${bfile} \
           --cojo-file ${dir}/${p}.ma \
           --extract ${dir}/${pr}.prune.in \
           --cojo-slct \
           --cojo-p 5e-10 \
           --cojo-collinear 0.9 \
           --maf 0.01 \
           --out ${dir}/${pr}

  R -q --no-save <<\ \ END
    options(scipen=20, width=2000)
    d <- Sys.getenv("dir")
    pr <- Sys.getenv("pr")
    jma <- read.delim(paste0(d,"/",pr,".jma.cojo"),as.is=TRUE)
    ldr <- read.delim(paste0(d,"/",pr,".ldr.cojo"), as.is=TRUE)
    tbl <- jma[setdiff(names(jma),c("b","se","p"))]
    load(paste0(pr,".rda"))
    library(gap)
    tbl <- within(tbl, {lp <- log10p(bJ/bJ_se)})
    cred <- cs(tbl, log_p="lp", cutoff=0.95)
    require(openxlsx)
    xlsx <- paste0(pr,"-GCTA.xlsx")
    wb <- createWorkbook(xlsx)
    f <- make.names(pr)
    addWorksheet(wb, paste0(f, ".jma"))
    writeDataTable(wb, paste0(f, ".jma"), merge(snpid_rsid,jma,by.x="rsid",by.y="SNP"))
    addWorksheet(wb, paste0(f, ".ldr"))
    writeDataTable(wb, paste0(f, ".ldr"), merge(snpid_rsid,ldr,by.x="rsid",by.y="SNP"))
    addWorksheet(wb, paste0(f, ".cs"))
    writeDataTable(wb, paste0(f, ".cs"),  merge(snpid_rsid,cred,by.x="rsid",by.y="SNP"))
    saveWorkbook(wb, file=xlsx, overwrite=TRUE)
  END
}

function jam()
{
  export data_type=bgen
  if [ $data_type == "bgen" ]; then cut -d' ' -f1,2 ${sample} | awk 'NR>2' > ${study}.id; fi
  if [ $data_type == "binary_ped" ]; then qctool -g ${pr}.bgen -s ${sample} -ofiletype binary_ped -og ${pr}; fi
  R -q --no-save <<\ \ END
    options(scipen=20, width=2000)
    f <- Sys.getenv("pr")
    s <- Sys.getenv('study')
    data_type <- Sys.getenv("data_type")
  # summary statistics
    sumstats <- read.table(paste0(f,".z"), as.is=TRUE, header=TRUE)
  # snpid-rsid mapping
    load(paste0(f,".rda"))
    sumstats <- merge(sumstats, snpid_rsid, by="rsid")
  # reference data
    if (data_type == "bgen")
    {
      require(rbgen)
      samples <- matrix(scan(paste0(s,".id"), what=c("","")), ncol=2, byrow=TRUE)
      d <- bgen.load(paste0(f,".bgen"), rsids=scan(paste0(f,".incl"), what=""))
      dimnames(d$data)[[2]] <- samples[,1]
      vid <- as.character(with(with(d, variants), rsid))
      R <- t(apply(d$data,1:2,"%*%",2:0))
    } else if (data_type == "binary_ped" ) {
      library(plink2R)
      p <- read_plink(f)
      vid <- with(with(p, bim), V2)
      R <- with(p, as.data.frame(2-bed))
    }
    for (i in 1:ncol(R)) R[is.na(R[,i]), i] <- mean(R[,i], na.rm = TRUE)
    ref <- list(rsid=vid,R=R)
    X.ref <- with(ref, R)
    ss <- subset(sumstats, rsid %in% with(ref, rsid))
    beta <- with(ss, beta)
    rsid <- with(ss, name)
    snpid <- with(ss, rsid)
    require(R2BGLiMS)
    ssnpid <- paste0("snp", 1:length(beta))
    names(beta) <- colnames(X.ref) <- ssnpid
    priors <- list("a"=1, "b"=length(beta), "Variables"=ssnpid) # ssnpid
    n <- as.numeric(Sys.getenv("N"))
    j <- JAM(marginal.betas=beta, n=n, X.ref=X.ref, n.mil=5, tau=n, full.mcmc.sampling = FALSE, model.space.priors=priors)
    save(j,file=paste0(f,".j"))
    pst <- slot(j, "posterior.summary.table")
    tm <- TopModels(j)
    ssr <- data.frame(ssnpid=ssnpid, snpid=snpid, rsid=rsid)
    cs <- CredibleSet(j, credible.percentile.threshold=0.75)
    msbf <- ModelSizeBayesFactors(j)[[1]]
    n.col <- ncol(tm)
    n.snps <- n.col-1
    post.prob <- tm[,n.col]
    n.sel <- apply(tm[,1:n.snps],1,sum)
    tm1 <- tm[1,-n.col]
    selected <- names(tm1[tm1==1])
    if(n.sel[1]>0&n.sel[1]!=n.snps)
    {
       PostProb_model <- rep(post.prob[1],n.sel[1])
       t <- cbind(subset(ssr,ssnpid%in%selected), PostProb_model, subset(pst,rownames(pst)%in%selected))
       write.table(t,paste0(f,".sel"),row.names=FALSE,quote=FALSE)
    }
    require(openxlsx)
    xlsx <- paste0(f,"-JAM.xlsx")
    wb <- createWorkbook(xlsx)
    addWorksheet(wb, "ID")
    writeDataTable(wb, "ID", ssr)
    addWorksheet(wb, "TopModels")
    writeDataTable(wb, "TopModels", as.data.frame(tm))
    addWorksheet(wb, "Model.1")
    PostProb_model <- rep(post.prob[1],n.sel[1])
    writeDataTable(wb, "Model.1", cbind(subset(ssr,ssnpid%in%selected),PostProb_model,subset(pst,rownames(pst)%in%selected)))
    addWorksheet(wb, "CredibleSet")
    writeDataTable(wb, "CredibleSet", cbind(subset(ssr,ssnpid%in%cs),subset(pst,rownames(pst)%in%cs)))
    addWorksheet(wb, "ModelSizeBayesFactors")
    writeDataTable(wb, "ModelSizeBayesFactors", as.data.frame(msbf))
    addWorksheet(wb, "posterior.summary.table")
    writeDataTable(wb, "posterior.summary.table", cbind(ID=rownames(pst), as.data.frame(pst)))
    saveWorkbook(wb, file=xlsx, overwrite=TRUE)
  END
}

init
finemap
gcta
jam
